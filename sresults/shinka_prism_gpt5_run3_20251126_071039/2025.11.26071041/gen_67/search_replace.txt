<candidate_pruning_before_local_search>
Introduce candidate deduplication and pruning before running local search to reduce computation while preserving solution quality. We compute a signature for each placement to eliminate duplicates and keep only the top-K candidates by raw max KVPR for refinement. This focuses local optimization on promising placements, often improving runtime and stability without hurting KVPR.
</DESCRIPTION>
<DIFF>
<<<<<<< SEARCH
    if not candidates:
        raise ValueError("Unable to construct any feasible placement")

    # Improve each candidate locally and pick the best by measured max KVPR
    improved_candidates = []
    for plc in candidates:
        improved_candidates.append(improve_local(plc))

    best_plc = None
    best_score = float('inf')
    for plc in improved_candidates:
        score = measured_max_kvpr(plc)
        if score < best_score:
            best_score = score
            best_plc = plc
=======
    if not candidates:
        raise ValueError("Unable to construct any feasible placement")

    # Deduplicate and prune candidates before local refinement to speed up and focus on promising ones
    def plc_signature(plc):
        pairs = []
        for g in range(gpu_num):
            for m in plc.get(g, []):
                pairs.append((id(m), g))
        pairs.sort()
        return tuple(pairs)

    uniq = {}
    for plc in candidates:
        try:
            sig = plc_signature(plc)
        except Exception:
            sig = None
        score = measured_max_kvpr(plc)
        key = sig if sig is not None else ("nosig", score, len(uniq))
        if (key not in uniq) or (score < uniq[key][0]):
            uniq[key] = (score, plc)

    # Keep top-K candidates (by raw max KVPR) for local search
    sorted_plcs = [v[1] for v in sorted(uniq.values(), key=lambda x: x[0])]
    top_k = 8 if len(sorted_plcs) > 8 else len(sorted_plcs)
    candidates = sorted_plcs[:top_k]

    # Improve each candidate locally and pick the best by measured max KVPR
    improved_candidates = []
    for plc in candidates:
        improved_candidates.append(improve_local(plc))

    best_plc = None
    best_score = float('inf')
    for plc in improved_candidates:
        score = measured_max_kvpr(plc)
        if score < best_score:
            best_score = score
            best_plc = plc
>>>>>>> REPLACE

</DIFF>