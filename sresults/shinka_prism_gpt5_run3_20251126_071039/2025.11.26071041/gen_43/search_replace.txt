<NAME>
hybrid_policy_and_stronger_bounds
</NAME>

<DESCRIPTION>
Introduce a hybrid GPU-choice policy during T-based packing that jointly considers projected global KVPR, local KVPR, and memory imbalance to better balance both KV cache pressure and memory usage. This hybrid rule uses a normalized score J = K_after_norm + α·kv_new_norm + β·mem_imbalance and is evaluated alongside existing policies to yield additional candidates with potentially lower max KVPR. Additionally, strengthen feasibility lower bounds by expanding the heavy-pair check set (top-120 by size) and extending the k-prefix bound to k up to min(G, 6). Expand the evaluated T-neighborhood and include more policy/order combinations to slightly improve solution quality while maintaining simplicity and performance.
</DESCRIPTION>

<DIFF>
<<<<<<< SEARCH
            L = min(len(items), 80)
=======
            L = min(len(items), 120)
>>>>>>> REPLACE

</DIFF>
<DIFF>
<<<<<<< SEARCH
            max_k = min(gpu_num, 4)
=======
            max_k = min(gpu_num, 6)
>>>>>>> REPLACE

</DIFF>
<DIFF>
<<<<<<< SEARCH
        low_T = max(0.0, indiv_lb, global_lb, pair_lb, kprefix_lb)
=======
        low_T = max(0.0, indiv_lb, global_lb, pair_lb, kprefix_lb)
        avg_mem_frac = (total_mem / total_capacity) if total_capacity > 0 else 0.0
>>>>>>> REPLACE

</DIFF>
<DIFF>
<<<<<<< SEARCH
                    if policy == "resid":
                        key = (resid, -(GPU_MEM_SIZE - (m_sum[g] + ms)), g)
                    else:
                        new_local = kvpr(n_sum[g] + n, GPU_MEM_SIZE - (m_sum[g] + ms))
                        # New global max if placed on g
                        new_max = new_local
                        for k in range(gpu_num):
                            if k != g and cur_kvprs[k] > new_max:
                                new_max = cur_kvprs[k]
                        # prefer smaller new_max, then smaller local, then residual, then more remaining mem, then id
                        key = (new_max, new_local, resid, -(GPU_MEM_SIZE - (m_sum[g] + ms)), g)
=======
                    if policy == "resid":
                        key = (resid, -(GPU_MEM_SIZE - (m_sum[g] + ms)), g)
                    elif policy == "minmax":
                        new_local = kvpr(n_sum[g] + n, GPU_MEM_SIZE - (m_sum[g] + ms))
                        # New global max if placed on g
                        new_max = new_local
                        for k in range(gpu_num):
                            if k != g and cur_kvprs[k] > new_max:
                                new_max = cur_kvprs[k]
                        # prefer smaller new_max, then smaller local, then residual, then more remaining mem, then id
                        key = (new_max, new_local, resid, -(GPU_MEM_SIZE - (m_sum[g] + ms)), g)
                    else:
                        # Hybrid policy: combine projected global KVPR, local KVPR, and memory imbalance
                        new_local = kvpr(n_sum[g] + n, GPU_MEM_SIZE - (m_sum[g] + ms))
                        new_max = new_local
                        for k in range(gpu_num):
                            if k != g and cur_kvprs[k] > new_max:
                                new_max = cur_kvprs[k]
                        mem_frac = (m_sum[g] + ms) / GPU_MEM_SIZE
                        K_after_norm = max(0.0, new_max) / max(T * GPU_MEM_SIZE, 1e-12)
                        kv_new_norm = new_local / max(T, 1e-12)
                        mem_imb = abs(mem_frac - avg_mem_frac)
                        alpha = 0.15
                        beta = 0.05
                        J = K_after_norm + alpha * kv_new_norm + beta * mem_imb
                        # prefer smaller J, then smaller new_max/local, then residual, then more remaining mem, then id
                        key = (J, new_max, new_local, resid, -(GPU_MEM_SIZE - (m_sum[g] + ms)), g)
>>>>>>> REPLACE

</DIFF>
<DIFF>
<<<<<<< SEARCH
        Ts = [high, high * 0.995, high * 1.005]
=======
        Ts = [high, high * 0.995, high * 1.005, high * 0.99, high * 1.01]
>>>>>>> REPLACE

</DIFF>
<DIFF>
<<<<<<< SEARCH
        combos = [(0, "resid"), (1, "resid"), (2, "resid"), (0, "minmax"), (1, "minmax")]
=======
        combos = [
            (0, "resid"), (1, "resid"), (2, "resid"),
            (0, "minmax"), (1, "minmax"), (2, "minmax"),
            (0, "hybrid"), (1, "hybrid"), (2, "hybrid")
        ]
>>>>>>> REPLACE

</DIFF>