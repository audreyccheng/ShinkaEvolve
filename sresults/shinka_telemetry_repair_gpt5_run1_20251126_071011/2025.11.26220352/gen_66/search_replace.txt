<NAME>
router_ratio_penalty_and_remaining_pair_budget
</NAME>

<DESCRIPTION>
We make three targeted improvements to enhance calibration and accuracy:
1) Track the raw router ratio s_raw = sum_other_dir/sum_this_dir per router and apply a small confidence penalty when it deviates strongly from 1.0. This reflects uncertainty from aggressive router scaling.
2) Track absolute per-interface router adjustments (router_delta_abs) and use the remaining cap (20% of pre-router value minus router edits) during pair reconciliation. This prevents overcorrection across passes and improves calibration.
3) Slightly boost redistribution weights on highly inconsistent links (residual > 2× tolerance) to focus corrections where redundant signals disagree most, improving counter accuracy.

All changes are minimal and consistent with the existing structure.
</DESCRIPTION>

<DIFF>
<<<<<<< SEARCH
    router_imbalance: Dict[str, float] = {}
    post_router: Dict[str, Dict[str, float]] = {i: {'rx': pre[i]['pre_rx'], 'tx': pre[i]['pre_tx']} for i in telemetry}
    router_delta_rel: Dict[str, Dict[str, float]] = {i: {'rx': 0.0, 'tx': 0.0} for i in telemetry}
=======
    router_imbalance: Dict[str, float] = {}
    post_router: Dict[str, Dict[str, float]] = {i: {'rx': pre[i]['pre_rx'], 'tx': pre[i]['pre_tx']} for i in telemetry}
    router_delta_rel: Dict[str, Dict[str, float]] = {i: {'rx': 0.0, 'tx': 0.0} for i in telemetry}
    # Track absolute magnitude of router edits for remaining pair budget
    router_delta_abs: Dict[str, Dict[str, float]] = {i: {'rx': 0.0, 'tx': 0.0} for i in telemetry}
    # Store raw router ratio (pre-bounding) for confidence calibration
    s_raw_map: Dict[str, float] = {rid: 1.0 for rid in topology}
>>>>>>> REPLACE

</DIFF>
<DIFF>
<<<<<<< SEARCH
        if dir_to_scale == 'tx':
            s = sum_rx / max(sum_tx, EPS)
        else:
            s = sum_tx / max(sum_rx, EPS)
        s_bounded = clamp(s, 0.85, 1.15)
        alpha = clamp(imbalance / 0.15, 0.25, 0.6)
        k = 1.0 + alpha * (s_bounded - 1.0)
=======
        if dir_to_scale == 'tx':
            s = sum_rx / max(sum_tx, EPS)
        else:
            s = sum_tx / max(sum_rx, EPS)
        s_bounded = clamp(s, 0.85, 1.15)
        alpha = clamp(imbalance / 0.15, 0.25, 0.6)
        k = 1.0 + alpha * (s_bounded - 1.0)
        # Save raw ratio for later confidence calibration
        s_raw_map[router_id] = s
>>>>>>> REPLACE

</DIFF>
<DIFF>
<<<<<<< SEARCH
            if dir_to_scale == 'tx':
                old = post_router[i]['tx']
                # Confidence proxy and residual on pair for weighting
                peer_id = peers.get(i)
                conf_dir = max(0.0, 1.0 - pre[i]['tx_link_diff'])
                if peer_id and peer_id in telemetry and pre[peer_id]['local_status'] == 'up':
                    resid = rel_diff(pre[i]['pre_tx'], pre[peer_id]['pre_rx'])
                    tol = pair_tolerance(pre[i]['pre_tx'], pre[peer_id]['pre_rx'])
                    sev = min(2.0, resid / max(tol, EPS))
                else:
                    sev = 0.0
                vol = old / sum_dir
                w = 0.6 * (1.0 - conf_dir) + 0.25 * sev + 0.15 * vol
                if old < 1.0:
                    w *= 0.5
                w = max(0.02, w)
                delta_target = old * (k - 1.0)
                cap_abs = 0.15 * max(old, 1.0)
                move = clamp(delta_target * w, -cap_abs, cap_abs)
                new_val = max(0.0, old + move)
                post_router[i]['tx'] = new_val
                router_delta_rel[i]['tx'] = abs(move) / max(old, 1.0)
=======
            if dir_to_scale == 'tx':
                old = post_router[i]['tx']
                # Confidence proxy and residual on pair for weighting
                peer_id = peers.get(i)
                conf_dir = max(0.0, 1.0 - pre[i]['tx_link_diff'])
                if peer_id and peer_id in telemetry and pre[peer_id]['local_status'] == 'up':
                    resid = rel_diff(pre[i]['pre_tx'], pre[peer_id]['pre_rx'])
                    tol = pair_tolerance(pre[i]['pre_tx'], pre[peer_id]['pre_rx'])
                    sev = min(2.0, resid / max(tol, EPS))
                else:
                    sev = 0.0
                vol = old / sum_dir
                w = 0.6 * (1.0 - conf_dir) + 0.25 * sev + 0.15 * vol
                if old < 1.0:
                    w *= 0.5
                # Small boost for highly inconsistent pairs to focus corrections
                if peer_id and peer_id in telemetry and pre[peer_id]['local_status'] == 'up':
                    if resid > 2.0 * tol:
                        w += 0.1
                w = max(0.02, w)
                delta_target = old * (k - 1.0)
                cap_abs = 0.15 * max(old, 1.0)
                move = clamp(delta_target * w, -cap_abs, cap_abs)
                new_val = max(0.0, old + move)
                post_router[i]['tx'] = new_val
                router_delta_rel[i]['tx'] = abs(move) / max(old, 1.0)
                router_delta_abs[i]['tx'] += abs(move)
>>>>>>> REPLACE

</DIFF>
<DIFF>
<<<<<<< SEARCH
            else:
                old = post_router[i]['rx']
                peer_id = peers.get(i)
                conf_dir = max(0.0, 1.0 - pre[i]['rx_link_diff'])
                if peer_id and peer_id in telemetry and pre[peer_id]['local_status'] == 'up':
                    resid = rel_diff(pre[i]['pre_rx'], pre[peer_id]['pre_tx'])
                    tol = pair_tolerance(pre[i]['pre_rx'], pre[peer_id]['pre_tx'])
                    sev = min(2.0, resid / max(tol, EPS))
                else:
                    sev = 0.0
                vol = old / sum_dir
                w = 0.6 * (1.0 - conf_dir) + 0.25 * sev + 0.15 * vol
                if old < 1.0:
                    w *= 0.5
                w = max(0.02, w)
                delta_target = old * (k - 1.0)
                cap_abs = 0.15 * max(old, 1.0)
                move = clamp(delta_target * w, -cap_abs, cap_abs)
                new_val = max(0.0, old + move)
                post_router[i]['rx'] = new_val
                router_delta_rel[i]['rx'] = abs(move) / max(old, 1.0)
=======
            else:
                old = post_router[i]['rx']
                peer_id = peers.get(i)
                conf_dir = max(0.0, 1.0 - pre[i]['rx_link_diff'])
                if peer_id and peer_id in telemetry and pre[peer_id]['local_status'] == 'up':
                    resid = rel_diff(pre[i]['pre_rx'], pre[peer_id]['pre_tx'])
                    tol = pair_tolerance(pre[i]['pre_rx'], pre[peer_id]['pre_tx'])
                    sev = min(2.0, resid / max(tol, EPS))
                else:
                    sev = 0.0
                vol = old / sum_dir
                w = 0.6 * (1.0 - conf_dir) + 0.25 * sev + 0.15 * vol
                if old < 1.0:
                    w *= 0.5
                # Small boost for highly inconsistent pairs to focus corrections
                if peer_id and peer_id in telemetry and pre[peer_id]['local_status'] == 'up':
                    if resid > 2.0 * tol:
                        w += 0.1
                w = max(0.02, w)
                delta_target = old * (k - 1.0)
                cap_abs = 0.15 * max(old, 1.0)
                move = clamp(delta_target * w, -cap_abs, cap_abs)
                new_val = max(0.0, old + move)
                post_router[i]['rx'] = new_val
                router_delta_rel[i]['rx'] = abs(move) / max(old, 1.0)
                router_delta_abs[i]['rx'] += abs(move)
>>>>>>> REPLACE

</DIFF>
<DIFF>
<<<<<<< SEARCH
            # Cap moves (≤ 20% of current value)
            cap_a = 0.2 * max(a_tx, 1.0)
            cap_b = 0.2 * max(b_rx, 1.0)
=======
            # Cap moves using remaining per-direction budget (≤ 20% of pre-router value minus router edits)
            base_a = pre[iface]['pre_tx']
            base_b = pre[peer_id]['pre_rx']
            cap_a = max(0.0, 0.20 * max(base_a, 1.0) - router_delta_abs.get(iface, {}).get('tx', 0.0))
            cap_b = max(0.0, 0.20 * max(base_b, 1.0) - router_delta_abs.get(peer_id, {}).get('rx', 0.0))
>>>>>>> REPLACE

</DIFF>
<DIFF>
<<<<<<< SEARCH
            cap_a = 0.2 * max(a_rx, 1.0)
            cap_b = 0.2 * max(b_tx, 1.0)
=======
            base_a = pre[iface]['pre_rx']
            base_b = pre[peer_id]['pre_tx']
            cap_a = max(0.0, 0.20 * max(base_a, 1.0) - router_delta_abs.get(iface, {}).get('rx', 0.0))
            cap_b = max(0.0, 0.20 * max(base_b, 1.0) - router_delta_abs.get(peer_id, {}).get('tx', 0.0))
>>>>>>> REPLACE

</DIFF>
<DIFF>
<<<<<<< SEARCH
        rx_confidence = rx_link_conf * router_factor * rx_change_factor
        tx_confidence = tx_link_conf * router_factor * tx_change_factor

        # Penalties for heavy router scaling and pair adjustments to improve calibration
=======
        rx_confidence = rx_link_conf * router_factor * rx_change_factor
        tx_confidence = tx_link_conf * router_factor * tx_change_factor

        # Router scale intensity penalty using raw ratio deviation (pre-bounding)
        s_raw = s_raw_map.get(router_id, 1.0)
        dev = abs(1.0 - s_raw)
        if dev > 0.25:
            pen = min(0.05, 0.2 * dev)
            rx_confidence -= pen
            tx_confidence -= pen
        elif dev > 0.15:
            rx_confidence -= 0.03
            tx_confidence -= 0.03

        # Penalties for heavy router scaling and pair adjustments to improve calibration
>>>>>>> REPLACE

</DIFF>