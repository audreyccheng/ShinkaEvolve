<NAME>
capaware_confidence_and_tracking
</NAME>

<DESCRIPTION>
I propose to improve confidence calibration and slightly enhance repair targeting by tracking how much each interface was edited and whether per-interface caps were hit, then using this information in a refined, cap-aware confidence finalization step.

Key changes:
- Add per-interface tracking fields: edit magnitudes (absolute and relative), cap-hit flags, and multiplicative scaling indicators with their relative scaling extent.
- During the multiplicative pre-step and additive router redistribution, record edit magnitudes and cap hits and apply small, proportional confidence penalties.
- During pair reconciliation, also record edits so confidence can reflect additional post-pass adjustments.
- Replace the final confidence calibration with a two-slope change penalty plus explicit cap-hit and multiplicative-scale penalties, and a no-edit bonus. This is designed to improve confidence calibration by avoiding overconfidence when we had to make large or capped changes, and rewarding unchanged counters.

These changes are consistent with the Hodor-inspired validation and repair approach and align with the potential recommendations focused on weighted redistribution, caps, and refined confidence mapping. They should improve confidence_calibration without sacrificing counter repair accuracy, thus increasing the combined score.
</DESCRIPTION>

<DIFF>
<<<<<<< SEARCH
    for if_id, data in telemetry.items():
        interim[if_id] = {
            'rx': float(data.get('rx_rate', 0.0)),
            'tx': float(data.get('tx_rate', 0.0)),
            'rx_conf': 1.0,
            'tx_conf': 1.0,
            'status': data.get('interface_status', 'unknown'),
            'status_conf': 1.0,
            'connected_to': data.get('connected_to'),
            'local_router': data.get('local_router'),
            'remote_router': data.get('remote_router'),
            # Keep originals for output tuples
            'orig_rx': float(data.get('rx_rate', 0.0)),
            'orig_tx': float(data.get('tx_rate', 0.0)),
            'orig_status': data.get('interface_status', 'unknown'),
            # Track whether router-level edits touched this interface
            'touched': False,
        }
=======
    for if_id, data in telemetry.items():
        interim[if_id] = {
            'rx': float(data.get('rx_rate', 0.0)),
            'tx': float(data.get('tx_rate', 0.0)),
            'rx_conf': 1.0,
            'tx_conf': 1.0,
            'status': data.get('interface_status', 'unknown'),
            'status_conf': 1.0,
            'connected_to': data.get('connected_to'),
            'local_router': data.get('local_router'),
            'remote_router': data.get('remote_router'),
            # Keep originals for output tuples
            'orig_rx': float(data.get('rx_rate', 0.0)),
            'orig_tx': float(data.get('tx_rate', 0.0)),
            'orig_status': data.get('interface_status', 'unknown'),
            # Track whether router-level edits touched this interface
            'touched': False,
            # Edit tracking and cap indicators for confidence calibration
            'edit_rx_abs': 0.0,
            'edit_tx_abs': 0.0,
            'edit_rx_rel': 0.0,
            'edit_tx_rel': 0.0,
            'cap_hit_rx': False,
            'cap_hit_tx': False,
            'mult_scaled_rx': False,
            'mult_scaled_tx': False,
            'scaled_rel_rx': 0.0,
            'scaled_rel_tx': 0.0,
        }
>>>>>>> REPLACE
</DIFF>

<DIFF>
<<<<<<< SEARCH
        if abs(1.0 - m) > 1e-6:
            for i in up_list:
                if scale_rx:
                    old_v = max(0.0, float(interim[i]['rx']))
                else:
                    old_v = max(0.0, float(interim[i]['tx']))
                proposed = old_v * m
                delta = proposed - old_v
                cap = MULT_PRESTEP_CAP_FRAC * max(old_v, 1.0)
                delta = max(-cap, min(cap, delta))
                new_v = max(0.0, old_v + delta)
                if scale_rx:
                    interim[i]['rx'] = new_v
                else:
                    interim[i]['tx'] = new_v
                if abs(delta) > EPS:
                    # Confidence penalty scales with imbalance and relative change
                    delta_rel = rel_diff(old_v, new_v)
                    if scale_rx:
                        interim[i]['rx_conf'] = clamp(min(interim[i]['rx_conf'],
                                                          1.0 - min(1.0, 0.5 * imbalance + 0.5 * delta_rel + 0.5 * abs(1.0 - s_bounded))))
                    else:
                        interim[i]['tx_conf'] = clamp(min(interim[i]['tx_conf'],
                                                          1.0 - min(1.0, 0.5 * imbalance + 0.5 * delta_rel + 0.5 * abs(1.0 - s_bounded))))
                    interim[i]['touched'] = True
=======
        if abs(1.0 - m) > 1e-6:
            for i in up_list:
                if scale_rx:
                    old_v = max(0.0, float(interim[i]['rx']))
                else:
                    old_v = max(0.0, float(interim[i]['tx']))
                proposed = old_v * m
                delta = proposed - old_v
                cap = MULT_PRESTEP_CAP_FRAC * max(old_v, 1.0)
                delta = max(-cap, min(cap, delta))
                new_v = max(0.0, old_v + delta)
                if abs(delta) > EPS:
                    delta_rel = rel_diff(old_v, new_v)
                    if scale_rx:
                        interim[i]['rx'] = new_v
                        interim[i]['mult_scaled_rx'] = True
                        interim[i]['scaled_rel_rx'] = max(interim[i]['scaled_rel_rx'], delta_rel)
                        interim[i]['edit_rx_abs'] += abs(delta)
                        interim[i]['edit_rx_rel'] = max(interim[i]['edit_rx_rel'], delta_rel)
                        interim[i]['rx_conf'] = clamp(min(interim[i]['rx_conf'],
                                                          1.0 - min(1.0, 0.5 * imbalance + 0.5 * delta_rel + 0.5 * abs(1.0 - s_bounded))))
                    else:
                        interim[i]['tx'] = new_v
                        interim[i]['mult_scaled_tx'] = True
                        interim[i]['scaled_rel_tx'] = max(interim[i]['scaled_rel_tx'], delta_rel)
                        interim[i]['edit_tx_abs'] += abs(delta)
                        interim[i]['edit_tx_rel'] = max(interim[i]['edit_tx_rel'], delta_rel)
                        interim[i]['tx_conf'] = clamp(min(interim[i]['tx_conf'],
                                                          1.0 - min(1.0, 0.5 * imbalance + 0.5 * delta_rel + 0.5 * abs(1.0 - s_bounded))))
                    interim[i]['touched'] = True
                else:
                    # write back unchanged if no effective delta
                    if scale_rx:
                        interim[i]['rx'] = new_v
                    else:
                        interim[i]['tx'] = new_v
>>>>>>> REPLACE
</DIFF>

<DIFF>
<<<<<<< SEARCH
                old_v = values[i]
                new_v = max(0.0, old_v + d)
                values[i] = new_v
                cap_rem[i] = max(0.0, cap_rem[i] - abs(d))
                router_delta_remaining -= abs(d)
                need -= d
                # Write back and adjust confidence
                delta_rel = rel_diff(old_v, new_v)
                if scale_rx:
                    interim[i]['rx'] = new_v
                    interim[i]['rx_conf'] = clamp(min(interim[i]['rx_conf'],
                                                      1.0 - min(1.0, imbalance + 0.5 * delta_rel + 0.5 * abs(1.0 - s_bounded))))
                else:
                    interim[i]['tx'] = new_v
                    interim[i]['tx_conf'] = clamp(min(interim[i]['tx_conf'],
                                                      1.0 - min(1.0, imbalance + 0.5 * delta_rel + 0.5 * abs(1.0 - s_bounded))))
                interim[i]['touched'] = True
=======
                old_v = values[i]
                new_v = max(0.0, old_v + d)
                values[i] = new_v
                cap_rem[i] = max(0.0, cap_rem[i] - abs(d))
                router_delta_remaining -= abs(d)
                need -= d
                # Write back and adjust confidence, track edits and cap hits
                delta_rel = rel_diff(old_v, new_v)
                if scale_rx:
                    interim[i]['rx'] = new_v
                    interim[i]['edit_rx_abs'] += abs(new_v - old_v)
                    interim[i]['edit_rx_rel'] = max(interim[i]['edit_rx_rel'], delta_rel)
                    if cap_rem[i] <= EPS * 10:
                        interim[i]['cap_hit_rx'] = True
                    interim[i]['rx_conf'] = clamp(min(interim[i]['rx_conf'],
                                                      1.0 - min(1.0, imbalance + 0.5 * delta_rel + 0.5 * abs(1.0 - s_bounded))))
                else:
                    interim[i]['tx'] = new_v
                    interim[i]['edit_tx_abs'] += abs(new_v - old_v)
                    interim[i]['edit_tx_rel'] = max(interim[i]['edit_tx_rel'], delta_rel)
                    if cap_rem[i] <= EPS * 10:
                        interim[i]['cap_hit_tx'] = True
                    interim[i]['tx_conf'] = clamp(min(interim[i]['tx_conf'],
                                                      1.0 - min(1.0, imbalance + 0.5 * delta_rel + 0.5 * abs(1.0 - s_bounded))))
                interim[i]['touched'] = True
>>>>>>> REPLACE
</DIFF>

<DIFF>
<<<<<<< SEARCH
            if a_tx_new != a_tx_old:
                drel = rel_diff(a_tx_old, a_tx_new)
                interim[a_id]['tx'] = a_tx_new
                # Mild penalty proportional to normalized residual
                interim[a_id]['tx_conf'] = clamp(interim[a_id]['tx_conf'] * (1.0 - 0.3 * min(1.0, res_fwd / TOL_PAIR_LOCAL)))
            if b_rx_new != b_rx_old:
                drel = rel_diff(b_rx_old, b_rx_new)
                interim[b_id]['rx'] = b_rx_new
                interim[b_id]['rx_conf'] = clamp(interim[b_id]['rx_conf'] * (1.0 - 0.3 * min(1.0, res_fwd / TOL_PAIR_LOCAL)))
=======
            if a_tx_new != a_tx_old:
                drel = rel_diff(a_tx_old, a_tx_new)
                interim[a_id]['tx'] = a_tx_new
                interim[a_id]['edit_tx_abs'] += abs(a_tx_new - a_tx_old)
                interim[a_id]['edit_tx_rel'] = max(interim[a_id]['edit_tx_rel'], drel)
                interim[a_id]['touched'] = True
                # Mild penalty proportional to normalized residual
                interim[a_id]['tx_conf'] = clamp(interim[a_id]['tx_conf'] * (1.0 - 0.3 * min(1.0, res_fwd / TOL_PAIR_LOCAL)))
            if b_rx_new != b_rx_old:
                drel = rel_diff(b_rx_old, b_rx_new)
                interim[b_id]['rx'] = b_rx_new
                interim[b_id]['edit_rx_abs'] += abs(b_rx_new - b_rx_old)
                interim[b_id]['edit_rx_rel'] = max(interim[b_id]['edit_rx_rel'], drel)
                interim[b_id]['touched'] = True
                interim[b_id]['rx_conf'] = clamp(interim[b_id]['rx_conf'] * (1.0 - 0.3 * min(1.0, res_fwd / TOL_PAIR_LOCAL)))
>>>>>>> REPLACE
</DIFF>

<DIFF>
<<<<<<< SEARCH
            if a_rx_new != a_rx_old:
                drel = rel_diff(a_rx_old, a_rx_new)
                interim[a_id]['rx'] = a_rx_new
                interim[a_id]['rx_conf'] = clamp(interim[a_id]['rx_conf'] * (1.0 - 0.3 * min(1.0, res_rev / TOL_PAIR_LOCAL)))
            if b_tx_new != b_tx_old:
                drel = rel_diff(b_tx_old, b_tx_new)
                interim[b_id]['tx'] = b_tx_new
                interim[b_id]['tx_conf'] = clamp(interim[b_id]['tx_conf'] * (1.0 - 0.3 * min(1.0, res_rev / TOL_PAIR_LOCAL)))
=======
            if a_rx_new != a_rx_old:
                drel = rel_diff(a_rx_old, a_rx_new)
                interim[a_id]['rx'] = a_rx_new
                interim[a_id]['edit_rx_abs'] += abs(a_rx_new - a_rx_old)
                interim[a_id]['edit_rx_rel'] = max(interim[a_id]['edit_rx_rel'], drel)
                interim[a_id]['touched'] = True
                interim[a_id]['rx_conf'] = clamp(interim[a_id]['rx_conf'] * (1.0 - 0.3 * min(1.0, res_rev / TOL_PAIR_LOCAL)))
            if b_tx_new != b_tx_old:
                drel = rel_diff(b_tx_old, b_tx_new)
                interim[b_id]['tx'] = b_tx_new
                interim[b_id]['edit_tx_abs'] += abs(b_tx_new - b_tx_old)
                interim[b_id]['edit_tx_rel'] = max(interim[b_id]['edit_tx_rel'], drel)
                interim[b_id]['touched'] = True
                interim[b_id]['tx_conf'] = clamp(interim[b_id]['tx_conf'] * (1.0 - 0.3 * min(1.0, res_rev / TOL_PAIR_LOCAL)))
>>>>>>> REPLACE
</DIFF>

<DIFF>
<<<<<<< SEARCH
        # Change penalty to discourage overconfidence on large edits
        delta_tx_rel = rel_diff(r['orig_tx'], r['tx'])
        delta_rx_rel = rel_diff(r['orig_rx'], r['rx'])
        pen_tx = max(0.0, delta_tx_rel - HARDENING_THRESHOLD)
        pen_rx = max(0.0, delta_rx_rel - HARDENING_THRESHOLD)
        CHANGE_PENALTY_WEIGHT = 0.5
        final_tx_conf = clamp(base_tx_conf * (1.0 - CHANGE_PENALTY_WEIGHT * pen_tx))
        final_rx_conf = clamp(base_rx_conf * (1.0 - CHANGE_PENALTY_WEIGHT * pen_rx))

        if resolved_status == 'down':
            final_rx_conf = 0.9 if r['orig_rx'] <= TRAFFIC_EVIDENCE_MIN else 0.3
            final_tx_conf = 0.9 if r['orig_tx'] <= TRAFFIC_EVIDENCE_MIN else 0.3

        r['tx_conf'] = final_tx_conf
        r['rx_conf'] = final_rx_conf
=======
        # Refined, cap-aware confidence finalization with no-edit bonus
        edit_tx_rel = r.get('edit_tx_rel', rel_diff(r['orig_tx'], r['tx']))
        edit_rx_rel = r.get('edit_rx_rel', rel_diff(r['orig_rx'], r['rx']))
        cap_hit_tx = r.get('cap_hit_tx', False)
        cap_hit_rx = r.get('cap_hit_rx', False)
        scaled_rel_tx = r.get('scaled_rel_tx', 0.0)
        scaled_rel_rx = r.get('scaled_rel_rx', 0.0)

        def finalize_conf(base: float, edit_rel: float, cap_hit: bool, scaled_rel: float, orig_val: float, new_val: float) -> float:
            # Two-slope change penalty relative to tolerance; then cap-hit and scale penalties
            pen_factor = max(0.0, 1.0 - 0.6 * max(0.0, edit_rel - HARDENING_THRESHOLD))
            conf = clamp(base * pen_factor)
            if cap_hit:
                conf *= 0.9
            if scaled_rel > 0.0:
                conf *= (1.0 - min(0.15, 0.3 * scaled_rel))
            # No-edit bonus for stability
            if rel_diff(orig_val, new_val) <= 1e-3:
                conf = clamp(conf + 0.05)
            return clamp(conf)

        final_tx_conf = finalize_conf(base_tx_conf, edit_tx_rel, cap_hit_tx, scaled_rel_tx, r['orig_tx'], r['tx'])
        final_rx_conf = finalize_conf(base_rx_conf, edit_rx_rel, cap_hit_rx, scaled_rel_rx, r['orig_rx'], r['rx'])

        if resolved_status == 'down':
            final_rx_conf = 0.9 if r['orig_rx'] <= TRAFFIC_EVIDENCE_MIN else 0.3
            final_tx_conf = 0.9 if r['orig_tx'] <= TRAFFIC_EVIDENCE_MIN else 0.3

        r['tx_conf'] = final_tx_conf
        r['rx_conf'] = final_rx_conf
>>>>>>> REPLACE
</DIFF>